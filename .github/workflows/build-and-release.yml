name: Build and Release APK

on:
  push:
    branches:
      - main
    # Only trigger on merges to main (PR merges), not direct pushes
    # Direct pushes are blocked by branch protection
  workflow_dispatch: # Allows manual triggering

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      
    - name: Create debug keystore
      run: |
        cd android
        keytool -genkey -v -keystore debug.keystore \
          -storepass android \
          -alias androiddebugkey \
          -keypass android \
          -keyalg RSA \
          -keysize 2048 \
          -validity 10000 \
          -dname "CN=Android Debug,O=Android,C=US"
      
    - name: Grant execute permission for gradlew
      run: chmod +x android/gradlew
      
    - name: Build Release APK
      run: |
        cd android
        ./gradlew :app:assembleRelease --no-daemon
        
    - name: Get APK filename
      id: apk_name
      run: |
        cd android/app/build/outputs/apk/release
        APK_FILE=$(ls *.apk | head -1)
        echo "apk_file=$APK_FILE" >> $GITHUB_OUTPUT
        echo "APK file: $APK_FILE"
        
    - name: Get version info
      id: version
      run: |
        cd android
        # Extract versionCode (works on both macOS and Linux)
        VERSION_CODE=$(grep 'versionCode' app/build.gradle | sed -E 's/.*versionCode[[:space:]]+([0-9]+).*/\1/')
        # Extract versionName (works on both macOS and Linux)
        VERSION_NAME=$(grep 'versionName' app/build.gradle | sed -E 's/.*versionName[[:space:]]+"([^"]+)".*/\1/')
        echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
        echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
        echo "Version: $VERSION_NAME (Code: $VERSION_CODE)"
        
    - name: Check if tag exists
      id: check_tag
      run: |
        VERSION_NAME="${{ steps.version.outputs.version_name }}"
        TAG="v${VERSION_NAME}"
        if git ls-remote --tags origin "$TAG" | grep -q "$TAG"; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Tag $TAG already exists - will update existing release"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Tag $TAG is new - will create new release"
        fi
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        
    - name: Create Release Tag
      id: create_tag
      run: |
        VERSION_NAME="${{ steps.version.outputs.version_name }}"
        VERSION_CODE="${{ steps.version.outputs.version_code }}"
        TAG="${{ steps.check_tag.outputs.tag }}"
        BUILD_DATE=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
        COMMIT_SHORT="${{ github.sha }}"
        COMMIT_SHORT="${COMMIT_SHORT:0:7}"
        
        echo "tag=$TAG" >> $GITHUB_OUTPUT
        echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
        echo "commit_short=$COMMIT_SHORT" >> $GITHUB_OUTPUT
        
        if [ "${{ steps.check_tag.outputs.exists }}" = "false" ]; then
          echo "Creating new tag: $TAG"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG" -m "Release $TAG (build $VERSION_CODE)"
          git push origin "$TAG"
        else
          echo "Tag $TAG already exists - updating release"
        fi
        
    - name: Generate release notes
      id: release_notes
      run: |
        VERSION_NAME="${{ steps.version.outputs.version_name }}"
        VERSION_CODE="${{ steps.version.outputs.version_code }}"
        BUILD_DATE="${{ steps.create_tag.outputs.build_date }}"
        COMMIT_SHORT="${{ steps.create_tag.outputs.commit_short }}"
        TAG_EXISTS="${{ steps.check_tag.outputs.exists }}"
        
        if [ "$TAG_EXISTS" = "true" ]; then
          RELEASE_NAME="Release ${VERSION_NAME} (Updated)"
          WARNING="⚠️ **Note:** This release has been updated with a new build. The version number has not changed."
          PREVIOUS_BUILDS="### This release has been updated. Previous builds with the same version are no longer available."
        else
          RELEASE_NAME="Release ${VERSION_NAME}"
          WARNING=""
          PREVIOUS_BUILDS=""
        fi
        
        cat > /tmp/release_body.md << EOF
        ## SMA Alerts Android App
        
        **Version:** ${VERSION_NAME}
        **Build Code:** ${VERSION_CODE}
        **Build Date:** ${BUILD_DATE}
        **Commit:** \`${COMMIT_SHORT}\`
        
        ${WARNING}
        
        ### Installation
        
        1. Download the APK file below
        2. Transfer to your Android device
        3. Enable "Install from Unknown Sources" if prompted
        4. Tap the APK to install
        
        ### Changes
        
        This release includes all changes from commit ${{ github.sha }}
        
        [View Changes](https://github.com/${{ github.repository }}/compare/${{ github.event.before }}...${{ github.sha }})
        
        ${PREVIOUS_BUILDS}
        EOF
        
        echo "release_name=$RELEASE_NAME" >> $GITHUB_OUTPUT
        echo "release_body<<EOF" >> $GITHUB_OUTPUT
        cat /tmp/release_body.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create or Update Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.create_tag.outputs.tag }}
        name: ${{ steps.release_notes.outputs.release_name }}
        body: ${{ steps.release_notes.outputs.release_body }}
        files: |
          android/app/build/outputs/apk/release/${{ steps.apk_name.outputs.apk_file }}
        draft: false
        prerelease: false
        overwrite: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: android/app/build/outputs/apk/release/${{ steps.apk_name.outputs.apk_file }}
        retention-days: 30

